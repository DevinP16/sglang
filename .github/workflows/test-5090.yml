name: 5090 GPU Test

on:
  # TODO: Remove pull_request trigger after testing
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/test-5090.yml'
  workflow_dispatch:
    inputs:
      run_accuracy:
        description: 'Run accuracy-test-1-gpu'
        type: boolean
        default: true
      run_perf_part1:
        description: 'Run performance-test-1-gpu-part-1'
        type: boolean
        default: true
      run_perf_part2:
        description: 'Run performance-test-1-gpu-part-2'
        type: boolean
        default: true
      run_perf_part3:
        description: 'Run performance-test-1-gpu-part-3'
        type: boolean
        default: true
  schedule:
    # Run daily at 2 AM UTC to track 5090 compatibility
    - cron: '0 2 * * *'

concurrency:
  group: 5090-test-${{ github.ref }}
  cancel-in-progress: true

env:
  RUNNER_LABELS: 1-gpu-5090
  SGLANG_IS_IN_CI: "true"
  LD_LIBRARY_PATH: "/usr/local/cuda-12.4/targets/x86_64-linux/lib:/usr/local/lib/python3.10/dist-packages/nvidia/cudnn/lib:/usr/local/lib/python3.10/dist-packages/nvidia/nvshmem/lib:/usr/local/lib/python3.10/dist-packages/nvidia/cuda_runtime/lib"

jobs:
  accuracy-test-1-gpu:
    if: |
      github.repository == 'sgl-project/sglang' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_accuracy)
    runs-on: 1-gpu-5090
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 15
        env:
          IS_BLACKWELL: "1"
        run: |
          bash scripts/ci/ci_install_dependency.sh
          git clone https://github.com/merrymercy/human-eval.git
          cd human-eval
          pip install -e .

      - name: Evaluate accuracy
        timeout-minutes: 25
        run: |
          source /etc/profile.d/sglang-ci.sh
          cd test/srt
          python3 -m sglang.test.ci.run_with_retry test_eval_accuracy_large.py

  performance-test-1-gpu-part-1:
    if: |
      github.repository == 'sgl-project/sglang' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_perf_part1)
    runs-on: 1-gpu-5090
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 15
        env:
          IS_BLACKWELL: "1"
        run: |
          bash scripts/ci/ci_install_dependency.sh

      - name: Benchmark single latency
        timeout-minutes: 10
        run: |
          source /etc/profile.d/sglang-ci.sh
          cd test/srt
          python3 -m unittest test_bench_one_batch.TestBenchOneBatch.test_bs1_small
          python3 -m unittest test_bench_one_batch.TestBenchOneBatch.test_bs1_default

  performance-test-1-gpu-part-2:
    if: |
      github.repository == 'sgl-project/sglang' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_perf_part2)
    runs-on: 1-gpu-5090
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 15
        env:
          IS_BLACKWELL: "1"
        run: |
          bash scripts/ci/ci_install_dependency.sh

      - name: Benchmark serving latency and throughput
        timeout-minutes: 20
        run: |
          source /etc/profile.d/sglang-ci.sh
          cd test/srt
          python3 -m unittest test_bench_serving.TestBenchServing.test_online_latency_default
          python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_default
          python3 -m unittest test_bench_serving.TestBenchServing.test_offline_throughput_non_stream_small_batch_size

  performance-test-1-gpu-part-3:
    if: |
      github.repository == 'sgl-project/sglang' &&
      (github.event_name != 'workflow_dispatch' || inputs.run_perf_part3)
    runs-on: 1-gpu-5090
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        timeout-minutes: 15
        env:
          IS_BLACKWELL: "1"
        run: |
          bash scripts/ci/ci_install_dependency.sh

      - name: Benchmark VLM
        timeout-minutes: 20
        run: |
          source /etc/profile.d/sglang-ci.sh
          cd test/srt
          python3 -m unittest test_bench_serving.TestBenchServing.test_vlm_offline_throughput
          python3 -m unittest test_bench_serving.TestBenchServing.test_vlm_online_latency

  summary:
    needs: [accuracy-test-1-gpu, performance-test-1-gpu-part-1, performance-test-1-gpu-part-2, performance-test-1-gpu-part-3]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Summary
        run: |
          echo "## 5090 GPU Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| accuracy-test-1-gpu | ${{ needs.accuracy-test-1-gpu.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| performance-test-1-gpu-part-1 | ${{ needs.performance-test-1-gpu-part-1.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| performance-test-1-gpu-part-2 | ${{ needs.performance-test-1-gpu-part-2.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| performance-test-1-gpu-part-3 | ${{ needs.performance-test-1-gpu-part-3.result }} |" >> $GITHUB_STEP_SUMMARY
